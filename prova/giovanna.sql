CREATE TABLE LEITOR
(COD_LEITOR INT NOT NULL PRIMARY KEY,
NOME VARCHAR(40) NOT NULL,
DT_NASC DATE);

INSERT INTO LEITOR VALUES
(1,'JOÃO','2000-01-01'),
(2,'MARIA','2000-02-02'),
(3,'JOSEFINA','2000-03-03'),
(4,'MARIAZINHA','1999-04-04');

CREATE TABLE FUNCIONARIO
(COD_FUNC INT NOT NULL PRIMARY KEY,
NOME VARCHAR(40) NOT NULL,
DT_NASC DATE);

INSERT INTO FUNCIONARIO VALUES
(1,'JOSÉ','2001-01-01'),
(2,'ANTÔNIO','2001-02-02'),
(3,'JOAQUIM','2001-03-03');

CREATE TABLE AUTOR
(COD_AUTOR INT NOT NULL PRIMARY KEY,
NOME VARCHAR(40) NOT NULL);

INSERT INTO AUTOR VALUES
(1,'ASTROGILDO'),
(2,'PLEBISCÍSTICA'),
(3,'ROMANOELA'),
(4,'AREOSWALDO');

CREATE TABLE TITULO
(COD_TIT INT NOT NULL PRIMARY KEY,
NOME VARCHAR(100) NOT NULL);

INSERT INTO TITULO VALUES
(1,'INTRODUÇÃO À BANCO DE DADOS'),
(2,'A VOLTA DOS QUE NÃO FORAM'),
(3,'RAPUNZEL E OS 22 ANÕES'),
(4,'A FADA DA GARANTA');


CREATE TABLE AUTORIA
(COD_AUTORIA INT NOT NULL PRIMARY KEY,
COD_TIT INT NOT NULL REFERENCES TITULO(COD_TIT),
COD_AUTOR INT NOT NULL REFERENCES AUTOR(COD_AUTOR));

INSERT INTO AUTORIA VALUES
(1,1,1),
(2,2,2),
(3,3,3),
(4,1,3),
(5,3,2);

CREATE TABLE LIVRO
(COD_LIVRO INT NOT NULL PRIMARY KEY,
STATUS VARCHAR(1) NOT NULL,
VALOR_MULTA_DIA INT NOT NULL,
COD_TIT INT NOT NULL REFERENCES TITULO(COD_TIT));

INSERT INTO LIVRO VALUES
(1,'D',5,1),
(2,'D',6,2),
(3,'D',4,3),
(4,'D',3,1),
(5,'D',9,2);

CREATE TABLE EMPRESTIMO
(COD_EMP INT NOT NULL PRIMARY KEY,
COD_LEITOR INT NOT NULL REFERENCES LEITOR(COD_LEITOR),
COD_LIVRO INT NOT NULL REFERENCES LIVRO(COD_LIVRO),
COD_FUNC INT NOT NULL REFERENCES FUNCIONARIO(COD_FUNC),
DT_EMP DATE NOT NULL,
DT_PREV_DEV DATE NOT NULL,
DT_DEV DATE);

INSERT INTO EMPRESTIMO VALUES
(1,1,1,1,'2020-01-01','2020-01-02','2020-01-02'),
(2,2,2,2,'2020-02-02','2020-02-03','2020-02-05'),
(3,3,3,3,'2020-03-03','2020-03-04','2020-03-08'),
(4,3,3,1,'2020-04-04','2020-04-05','2020-04-05'),
(5,2,2,2,'2020-05-05','2020-05-06','2020-05-16'),
(6,2,2,2,'2020-06-06','2020-06-07',NULL);

CREATE TABLE RESERVA
(COD_RES INT NOT NULL PRIMARY KEY,
COD_LEITOR INT NOT NULL REFERENCES LEITOR(COD_LEITOR),
COD_TIT INT NOT NULL REFERENCES TITULO(COD_TIT),
COD_FUNC INT NOT NULL REFERENCES FUNCIONARIO(COD_FUNC),
DT_RES DATE NOT NULL);

INSERT INTO RESERVA VALUES
(1,1,1,1,CURRENT_DATE),
(2,2,2,2,CURRENT_DATE),
(3,2,3,3,CURRENT_DATE);

INSERT INTO RESERVA VALUES
	(4,2,1,1,CURRENT_DATE),
	(5,2,3,1,CURRENT_DATE),
		(6,2,4,1,CURRENT_DATE);

SELECT * FROM LEITOR

DROP TABLE RESERVA; --ATUALIZAÇÃO
--questões

--Q1nome dos titulos dos livros emprestados para o leitor joao pelo funcionario jose
--ou os reservados para a leitora maria pelo funcionario antonio

SELECT DISTINCT TIT.NOME FROM 
	TITULO TIT NATURAL JOIN LIVRO L NATURAL JOIN EMPRESTIMO E JOIN FUNCIONARIO F ON E.COD_FUNC = F.COD_FUNC
	JOIN LEITOR LE ON E.COD_LEITOR = LE.COD_LEITOR
WHERE LE.NOME ILIKE 'JOÃO' AND F.NOME ILIKE 'JOSÉ'

	UNION

SELECT DISTINCT TIT.NOME FROM 
	TITULO TIT NATURAL JOIN RESERVA R JOIN FUNCIONARIO F ON R.COD_FUNC = F.COD_FUNC
	JOIN LEITOR LE ON R.COD_LEITOR = LE.COD_LEITOR
WHERE LE.NOME ILIKE 'MARIA' AND F.NOME ILIKE 'ANTÔNIO';
	
--Q2nome dos autores que escreveram os titulos reservados para a leitora Maria, mas que 
--nunca foram reservados para o leitor maiS jovem

SELECT A.NOME, COUNT(*) QTD FROM 
	AUTOR A NATURAL JOIN AUTORIA AUT 
	JOIN TITULO TIT ON TIT.COD_TIT = AUT.COD_TIT
	JOIN RESERVA R ON R.COD_TIT = TIT.COD_TIT 
	JOIN LEITOR LE ON R.COD_LEITOR = LE.COD_LEITOR
WHERE LE.NOME ILIKE 'MARIA' AND LE.DT_NASC NOT IN(
	SELECT MAX(DT_NASC) FROM LEITOR
)
	GROUP BY A.NOME;

--Q3para cada codigo e nome de leitor, o valor total pago em multas. mostrar apenas leitores que o valor da multa
--é maior que zero.

SELECT DISTINCT LE.COD_LEITOR, LE.NOME, ((E.DT_DEV - E.DT_PREV_DEV) * L.VALOR_MULTA_DIA) VALOR_TOTAL_MULTA 
FROM LEITOR LE LEFT JOIN EMPRESTIMO E ON E.COD_LEITOR = LE.COD_LEITOR JOIN LIVRO L ON E.COD_LIVRO = L.COD_LIVRO
WHERE ((E.DT_DEV - E.DT_PREV_DEV) * L.VALOR_MULTA_DIA) > 0;

--Q4Nome dos autores com a respectiva quantidade de titulos escritos. caso autor sem titulo informar 0

SELECT A.NOME, COALESCE(COUNT(AUT.COD_TIT), 0) QTD FROM AUTORIA AUT RIGHT JOIN AUTOR A ON A.COD_AUTOR = AUT.COD_AUTOR GROUP BY A.NOME;

--Q6nome dos leitores que reservaram todos os titulos

SELECT DISTINCT LE.NOME FROM LEITOR LE WHERE NOT EXISTS (
  SELECT * FROM TITULO TIT WHERE NOT EXISTS (
  SELECT * FROM RESERVA R WHERE R.COD_LEITOR = LE.COD_LEITOR AND R.COD_TIT = TIT.COD_TIT
	)
);